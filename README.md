# SAE-J1939 协议

## 简介

本项目是对SAE-J1939协议的C语言实现，具有以下特点

- 较高的可移植性. 本项目对接硬件衔接层的接口文件为`j1939_port.c/h`，用户可在`j1939_config.h`中选择硬件衔接层接口. 目前支持的硬件接口如下

<center>

| HAL接口宏 | 描述 |
| --- | --- |
| J1939_PORT_SUSPEND | 挂起，用于挂起协议进行调试 |
| J1939_PORT_VIRTUAL | 虚拟总线，用于纯软件仿真调试 |
| J1939_PORT_STM32 | STM32全系列HAL库接口 |

</center>

- 较高的封装程度. 本项目封装了大部分内部处理函数与数据结构，对外仅留出3个结构体与9个用户接口函数

<center>

| 结构体 | 名称 | 描述 |
| --- | --- | --- |
| `J1939_t` | J1939句柄 | 不完整类型指针，`struct J1939`被封装 |
| `J1939_Message_t` | J1939消息 | 用于存储CAN ID，消息字节数，消息载荷 |
| `J1939_PDU_t` | J1939协议数据单元 | 仅用于J1939消息结构体中的ID联合体 |

</center>

<center>

| 接口函数 | 描述 | 输入 | 输出 |
| --- | --- | --- | --- |
| `J1939_GetPGN` | 获取消息PGN | 消息ID | PGN |
| `J1939_SetPGN` | 设置消息PGN | 消息ID指针, PGN | PGN |
| `J1939_MessageCreate` | 创建J1939消息(长短报文复用此消息创建方法) | 消息ID，消息长度，载荷指针 | J1939消息句柄 |
| `J1939_MessageDelete` | 释放J1939消息 | J1939消息指针 | J1939状态 |
| `J1939_MessageCopy` | 复制一个J1939消息 | 将要复制的J1939消息 | 复制后的J1939消息 |
| `J1939_HandleCreate` | 创建J1939句柄 | HAL接口名称，1字节的协议地址，发送队列最大长度 | J1939句柄 |
| `J1939_HandleDelete` | 释放J1939句柄 | J1939句柄指针 | J1939状态 |
| `J1939_TaskHandler` | J1939任务处理，推荐5ms调用一次 | 无 | J1939状态 |
| `J1939_SendMessage` | 用一个HAL接口发送一个J1939消息(长短报文复用此消息发送方法) | J1939句柄，J1939消息 | J1939状态 |

</center>

- 较高的复用程度. 消息创建方法`J1939_MessageCreate()`与消息发送方法`J1939_SendMessage()`利用动态数组实现了长短报文消息创建&发送机制的复用；消息发送队列`J1939_t::TxFIFO`、虚拟总线`VirtualBus()`、虚拟节点`J1939_VirtualNode_t`与J1939句柄注册器`Register()`复用了`J1939_Queue_t`结构对应的系列方法，实现了J1939消息入队&出队、虚拟节点上线&下线、J1939句柄注册&注销等方法.

- 虚拟总线. 协议可通过`j1939_config.h`配置HAL为虚拟总线. 虚拟总线使得脱离硬件环境进行纯软件调试成为可能. 在虚拟总线的辅助下，用户可以方便的进行内存泄漏检测、收发回环测试、多帧消息传输协议测试，规避了调试不便的交叉编译应用场景.

- 兼容C++.

- 轮询收发.

## 使用

推荐将本项目作为子模块，这样可以不改变本项目的原有结构. 使用时复制`j1939_register.inc`到工程的include目录，并在其中填入工程的HAL CAN句柄名. 此外，还需复制`j1939_hcan.c`作为接口函数模板，在`J1939_EXTERN_FUNCTION_DEF( , )`宏的第一个输入槽内填入工程的HAL CAN句柄名. 接口函数将在编译时进行检测，需要与`j1939_register.inc`内注册的句柄保持一致.

## TODO

- 多帧传输协议的实现.
- 内存池?
- 虚拟多总线.
- 论证中断接收的可行性.

## Demo

<center>

| Demo | 描述 |
| --- | --- |
| `j1939_demo1.c` | 重复进行“创建、使用、销毁”过程，以测试协议稳定性 |
| `j1939_demo1.cpp` | C++环境 |
| `j1939_demo2.c` | BAM协议 |

</center>

## 参考文献

[1]丁海涛, 杨建森. SAE J1939协议[DB/OL]. [Link](http://blog.gitdns.org/2017/12/05/j1939-pctool/ourdev_509914(SAE-J1939).pdf), 2008年10月30日, 2022年02月02日
